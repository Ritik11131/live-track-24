<div class="grid" style="height: 90vh;"> 
  <!-- LEFT PANEL: Vehicle List -->
  <div
    class="col-12 sm:col-12 md:col-4 lg:col-4 xl:col-3 flex flex-column h-full"
   
    [ngSwitch]="showTemplate"
  >
    <div *ngIf="replayControls" class="flex flex-column h-full">
      <div *ngSwitchCase="'device-list'" class="flex flex-column h-full">

        <!-- Search + Button -->
        <div class="flex align-items-center mb-4 gap-3">
          <div class="flex-grow-1">
            <span class="p-input-icon-left w-full">
              <i class="pi pi-search"></i>
              <input
                type="text"
                placeholder="Search"
                class="p-inputtext-lg w-full"
                pInputText
                (input)="search()"
                [(ngModel)]="searchQuery"
              />
            </span>
          </div>
          <div>
            <p-button
              pTooltip="Refresh Vehicle List"
              tooltipPosition="top"
              [rounded]="true"
              icon="pi pi-refresh"
              (click)="getVehicleList()"
            ></p-button>
          </div>
        </div>

        <!-- Vehicle Categories -->
        <div class="flex justify-content-between align-items-center flex-wrap">
          <div
            *ngFor="let category of categories; let i = index"
            (click)="filterByCategory(category.description, i)"
            pRipple
            class="border-round flex-1 flex align-items-center justify-content-center p-1 gap-1 cursor-pointer"
            [class.active-category]="isActiveCategory(i)"
            [style.background-color]="
              isActiveCategory(i) ? 'var(--secondary-color)' : 'transparent'
            "
            [style.border]="isActiveCategory(i) ? '1px solid #ccc' : 'none'"
          >
            <div
              style="width: 25px; height: 25px"
              [style.background-color]="getcolor1(category.description)"
              class="border-circle flex justify-content-center align-items-center"
            >
              <i class="lni lni-truck-delivery-1 text-white"></i>
            </div>
            <p class="m-0">{{ category.count }}</p>
          </div>
        </div>

        <p-divider></p-divider>

        <!-- Vehicle List Scroll -->
        <div class="flex-grow-1 overflow-auto">
          <div
            class="w-full pr-3"
            *ngFor="let info of fileredVehicles"
          >
            <div
              class="flex flex-column overflow-hidden mb-3 border-200 surface-overlay border-1 border-round"
            >
              <div class="flex justify-content-start px-3 py-2">
                <div class="mr-3 align-self-center">
                  <i
                    class="lni lni-truck-delivery-1"
                    style="font-size: 2rem"
                    [ngStyle]="{ color: getColor(info.position.status.status) }"
                  ></i>
                </div>
                <div class="flex flex-column flex-grow-1">
                  <span class="block text-md font-medium">
                    {{ info.device!.vehicleNo }}
                  </span>
                  <span class="text-sm">
                    {{
                      getStatusName(info.position.status.status) +
                        " " +
                        (info.position.status.duration || "")
                    }}
                  </span>
                </div>
                <div class="flex align-items-center">
                  <i
                    pRipple
                    class="pi pi-chevron-right p-2 border-1 border-round"
                    style="font-size: 1.2rem; cursor: pointer; color: var(--primary-color)"
                    (click)="showDetails(info)"
                  ></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Device Details SwitchCase can stay as is -->
      <div *ngSwitchCase="'device-details'" class="flex flex-column h-full">
        <div class="grid flex-row px-4 justify-content-start align-items-center py-2">
          <div (click)="switchView()" class="cursor-pointer col-4 flex">
            <i
              class="pi pi-angle-left line-height-3"
              style="font-size: 1.5rem"
            ></i>
            <p>Back</p>
          </div>
          <h5 class="m-0 col-6" style="font-size: 14px">
            <b>{{ details_title }}</b>
          </h5>
          <p class="col-2 cursor-pointer" (click)="refreshDetailPage()">
            Refresh
          </p>
        </div>
        <div class="px-4"></div>

        <div class="graph">
          <p-tabMenu
            [ngClass]="'custom--item'"
            [model]="items"
            [activeItem]="activeItem"
            (activeItemChange)="onActiveItemChange($event)"
          ></p-tabMenu>
          <router-outlet></router-outlet>
        </div>
      </div>
    </div>
    <div
      class="fixed top-0 left-0 h-screen w-screen flex justify-content-center align-items-center"
      style="z-index: 99999; background-color: rgba(0, 0, 0, 0.6)"
      *ngIf="progressSpinner"
    >
      <p-progressSpinner></p-progressSpinner>
    </div>

    <div *ngIf="!replayControls" class="card h-full flex flex-column gap-2">
      <div class="flex flex-column gap-2" style="height: 43vh">
        <div
          class="flex gap-2 mb-2 flex-row justify-content-start align-items-center"
        >
          <div (click)="closeHistoryReplay()" class="cursor-pointer">
            <i class="pi pi-angle-left font-bold" style="font-size: 1.5rem"></i>
          </div>
          <div class="text-2xl font-bold">
            History Replay( {{ details_title }} )
          </div>
        </div>

        <div class="grid">
          <div class="col-5 text-xl p-1">Start Time</div>
          <div class="col-7 text-xl font-semibold p-1">
            {{ selectedStartDate | date : "yyyy-MM-dd, HH:mm:ss" }}
          </div>

          <div class="col-5 text-xl p-1">End Time</div>
          <div class="col-7 text-xl font-semibold p-1">
            {{ selectedEndDate | date : "yyyy-MM-dd, HH:mm:ss" }}
          </div>

          <div class="col-5 text-xl p-1">Time</div>
          <div class="col-7 text-xl font-semibold p-1">{{ timeStamp }}</div>
          <div class="col-5 text-xl p-1">Speed</div>
          <div class="col-7 text-xl font-semibold p-1">
            {{ VehicleSpeed }} km/hr
          </div>
          <div class="col-5 text-xl p-1">Travelled Distance</div>
          <div class="col-7 text-xl font-semibold p-1">
            {{ distanceTravelled.toFixed(3) }}Km
          </div>
          <div class="col-5 text-xl p-1">Total Distance</div>
          <div class="col-7 text-xl font-semibold p-1">
            {{ totalTravelDistance.toFixed(3) }}Km
          </div>
        </div>

        <div
          class="align-items-center gap-2 flex flex-row justify-content-between"
        >
          <div class="w-full">
            <input
              #seekbar
              class="w-full"
              type="range"
              [(ngModel)]="seekbarValue"
              (input)="updateProgress()"
              [disabled]="!playPause"
            />
            <div class="seekbar-progress" [style.width]="progressWidth"></div>
          </div>

          <button
            pButton
            (click)="playPauseFunction()"
            pRipple
            class="flex justify-content-center align-items-center border-circle"
            style="background-color: #1797b0; height: 35px; width: 40px"
          >
            <i
              [ngClass]="playPause ? 'pi pi-pause' : 'pi  pi-play'"
              style="font-size: 1.5rem; line-height: 1.5"
            ></i>
          </button>
          <button
            pButton
            (click)="changeSpeed()"
            pRipple
            class="flex justify-content-center align-items-center border-circle"
            style="background-color: #1797b0; height: 35px; width: 40px"
          >
            {{ speed }}x
          </button>
        </div>
        <div class="flex gap-2">
          <button
            pButton
            style="background-color: #1797b0"
            (click)="showIdlePoints()"
            class="w-full"
            label="Show Idles"
          ></button>
          <button
            pButton
            style="background-color: #1797b0"
            (click)="showStopPoints()"
            class="w-full"
            label="Show Stops"
          ></button>
          <button
            pButton
            style="background-color: #1797b0"
            (click)="restartMovement()"
            class="w-full"
            label="Restart"
          ></button>
        </div>
      </div>

      <div>
        <p-tabView>
          <p-tabPanel class="text-xl" header="Stop Points"
            ><ng-container *ngIf="tripStopLocations.length > 0; else noRecords">
              <div
                class="flex flex-column gap-2 overflow-y-scroll"
                style="height: 32vh"
              >
                <div
                  (click)="showStopPointOnMap(stop)"
                  *ngFor="let stop of tripStopLocations"
                  class="flex line-height-3 flex-column p-3 border-round-2xl bg-gray-100 shadow-2 gap-2"
                >
                  <div
                    class="flex flex-row justify-content-between cursor-pointer align-items-center"
                  >
                    <div
                      class="flex text-lg justify-content-start font-semibold"
                    >
                      {{ stop.dormantStart | date : "MMM dd, yyyy" }}
                    </div>
                    <div
                      class="flex text-lg justify-content-center align-items-center border-circle"
                    >
                      {{ stop.duration }}
                    </div>
                  </div>
                  <div class="flex flex-row justify-content-between">
                    <div class="flex flex-row justify-content-center gap-1">
                      <div class="text-lg">Start Time</div>
                      <div class="text-lg font-semibold text-green-500">
                        {{ stop.dormantStart | date : "HH:mm:ss" }}
                      </div>
                    </div>

                    <div class="flex flex-row justify-content-center gap-1">
                      <div class="text-lg">End Time</div>
                      <div class="text-lg font-semibold text-red-500">
                        {{ stop.dormantEnd | date : "HH:mm:ss" }}
                      </div>
                    </div>
                  </div>

                  <div class="flex flex-row text-lg">
                    {{ stop.address }}
                  </div>
                </div>
              </div>
            </ng-container>
            <ng-template #noRecords>
              <div
                class="flex justify-content-center align-items-center text-center"
              >
                No records found For this trip
              </div>
            </ng-template></p-tabPanel
          >
          <p-tabPanel class="text-xl" header="Idle Points"
            ><ng-container *ngIf="tripIdleLocations.length > 0; else noRecords">
              <div
                class="flex flex-column gap-2 overflow-y-scroll"
                style="height: 32vh"
              >
                <div
                  (click)="showIdlePointOnMap(idle)"
                  *ngFor="let idle of tripIdleLocations"
                  class="flex line-height-3 flex-column p-3 border-round-2xl bg-gray-100 shadow-2 gap-2"
                >
                  <div
                    class="flex flex-row cursor-pointer justify-content-between align-items-center"
                  >
                    <div
                      class="flex text-lg justify-content-start font-semibold"
                    >
                      {{ idle.dormantStart | date : "MMM dd, yyyy" }}
                    </div>
                    <div
                      class="flex text-lg justify-content-center align-items-center border-circle"
                    >
                      {{ idle.duration }}
                    </div>
                  </div>
                  <div class="flex flex-row justify-content-between">
                    <div class="flex flex-row justify-content-center gap-1">
                      <div class="text-lg">Start Time</div>
                      <div class="text-lg font-semibold text-green-500">
                        {{ idle.dormantStart | date : "HH:mm:ss" }}
                      </div>
                    </div>

                    <div class="flex flex-row justify-content-center gap-1">
                      <div class="text-lg">End Time</div>
                      <div class="text-lg font-semibold text-red-500">
                        {{ idle.dormantEnd | date : "HH:mm:ss" }}
                      </div>
                    </div>
                  </div>

                  <div class="flex flex-row text-lg">
                    {{ idle.address }}
                  </div>
                </div>
              </div>
            </ng-container>
            <ng-template #noRecords>
              <div
                class="flex justify-content-center align-items-center text-center"
              >
                No records found For this trip
              </div>
            </ng-template></p-tabPanel
          >
        </p-tabView>
      </div>
    </div>
  </div>

  <!-- RIGHT PANEL: Map -->
  <div
    class="col-12 sm:col-12 flex flex-column h-full"
    [ngClass]="{
      'col-11': fullDisplay,
      'md:col-7 lg:col-8 xl:col-9': !fullDisplay
    }"
  >
    <div class="flex flex-column h-full relative">
      <!-- Header -->
      <div class="flex align-items-center justify-content-between gap-2 mb-2">
        <p-multiSelect
          *ngIf="showTemplate === 'device-details' && replayControls"
          [options]="linkedGeofences"
          placeholder="Select Geofence"
          optionLabel="geometryName"
          optionValue="id"
          display="chip"
          class="w-3"
          [(ngModel)]="selectedGeofences"
          [showClear]="true"
          (onChange)="linkedGeofenceDropdown($event)"
        ></p-multiSelect>
      </div>

      <!-- Map grows -->
      <div id="map" class="flex-grow-1 w-full"></div>

      <!-- Floating Button -->
      <div class="top-right-button">
        <p-button
          *ngIf="showTemplate === 'device-details' && replayControls"
          tooltipPosition="top"
          pTooltip="Current Location"
          [rounded]="true"
          class="top-right-button"
          icon="pi pi-map-marker"
          severity="info"
          (click)="plotCurrentLocation()"
        />
      </div>
    </div>
  </div>
</div>

<p-toast></p-toast>
